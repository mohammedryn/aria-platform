<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; connect-src http://127.0.0.1:*; frame-src http://127.0.0.1:*; img-src vscode-resource: https: data: blob: http://127.0.0.1:*; script-src 'unsafe-inline'; style-src 'unsafe-inline'; media-src vscode-resource: https: data: blob: mediastream: http://127.0.0.1:*;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.R.I.A. Copilot</title>
    <style>
        :root {
            --container-paddding: 20px;
            --input-height: 40px;
        }
        body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Header */
        header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--vscode-panel-border);
            flex-shrink: 0;
        }
        h1 {
            font-size: 1.1em;
            margin: 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        h2 {
            font-size: 0.85em;
            color: var(--vscode-descriptionForeground);
            margin: 5px 0 0 0;
            font-weight: normal;
        }

        /* Result Stream (The "Output") */
        #result-stream {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .entry {
            margin-bottom: 10px;
        }
        .entry-command {
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
            color: var(--vscode-textPreformat-foreground);
            background: var(--vscode-textBlockQuote-background);
            padding: 8px 12px;
            border-radius: 4px;
            align-self: flex-start;
            display: inline-block;
            margin-bottom: 8px;
            border-left: 3px solid var(--vscode-textLink-activeForeground);
        }
        .entry-result {
            font-size: 0.95em;
            line-height: 1.5;
        }

        /* Thought Process (Markdown Style) */
        .thought-process-container {
            margin-top: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            overflow: hidden;
            background-color: var(--vscode-editor-inactiveSelectionBackground);
        }
        
        .thought-process-header {
            padding: 8px 12px;
            background-color: var(--vscode-editor-lineHighlightBackground);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--vscode-foreground);
            user-select: none;
        }
        
        .thought-process-header:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .thought-process-content {
            padding: 15px;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
            line-height: 1.6;
            color: var(--vscode-editor-foreground);
            white-space: pre-wrap;
            display: none; /* Hidden by default if closed */
        }

        .thought-process-content[open] {
            display: block;
        }

        /* Status Dot */
        .status-dot {
            height: 8px;
            width: 8px;
            background-color: var(--vscode-charts-blue);
            border-radius: 50%;
            display: inline-block;
        }
        
        /* Markdown Content Styling */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: var(--vscode-textLink-foreground);
        }
        .markdown-content code {
            font-family: var(--vscode-editor-font-family);
            background-color: var(--vscode-textCodeBlock-background);
            padding: 2px 4px;
            border-radius: 3px;
        }
        .markdown-content pre {
            background-color: var(--vscode-textCodeBlock-background);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        /* Suggestions */
        .suggestion-item {
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .suggestion-header {
            padding: 8px 12px;
            background: var(--vscode-sideBar-background);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
        }
        .suggestion-header:hover {
            background: var(--vscode-list-hoverBackground);
        }
        .suggestion-body {
            padding: 10px;
            display: none; /* Hidden by default */
            border-top: 1px solid var(--vscode-panel-border);
        }
        .suggestion-body.open {
            display: block;
        }
        .suggestion-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        button {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 6px 12px;
            border-radius: 2px;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover {
            background: var(--vscode-button-hoverBackground);
        }
        button.secondary {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        button.secondary:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }
        
        /* Input Area */
        #command-bar {
            padding: 15px 20px;
            border-top: 1px solid var(--vscode-panel-border);
            background: var(--vscode-editor-background);
            flex-shrink: 0;
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
            outline: none;
        }
        
        input[type="text"]:focus {
            border-color: var(--vscode-focusBorder);
        }
        
        input[type="text"]::placeholder {
            color: var(--vscode-input-placeholderForeground);
        }

        /* Status Indicator */
        .status-dot {
            height: 8px;
            width: 8px;
            background-color: var(--vscode-testing-iconPassed);
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        /* Autocomplete */
        #autocomplete-list {
            position: absolute;
            bottom: 100%; /* Position above the input */
            left: 0;
            right: 0;
            background-color: var(--vscode-menu-background);
            color: var(--vscode-menu-foreground);
            border: 1px solid var(--vscode-menu-border);
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--vscode-menu-separatorBackground);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover, .autocomplete-item.active {
            background-color: var(--vscode-menu-selectionBackground);
            color: var(--vscode-menu-selectionForeground);
        }

    </style>
</head>
<body>
    <header>
        <h1><span class="status-dot"></span>A.R.I.A. Copilot</h1>
        <h2>Hardware-Aware IDE Copilot</h2>
    </header>
    <div id="model-container" style="padding: 10px 20px; border-bottom: 1px solid var(--vscode-panel-border); background: var(--vscode-sideBar-background); display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 0.85em; opacity: 0.8;">Model</span>
        <select id="model-select" style="flex: 1; padding: 6px; background: var(--vscode-dropdown-background); color: var(--vscode-dropdown-foreground); border: 1px solid var(--vscode-dropdown-border); border-radius: 4px;"></select>
        <button id="model-refresh" class="secondary" style="padding: 6px 10px;">Refresh</button>
        <span id="model-status" style="font-size: 0.8em; opacity: 0.7;"></span>
    </div>

    <!-- Visual Hardware Context Section -->
    <div id="vision-container" style="padding: 15px 20px; border-bottom: 1px solid var(--vscode-panel-border); background: var(--vscode-sideBar-background); display: none;">
        <div style="display: flex; gap: 15px; align-items: flex-start;">
            <div id="vision-thumb" style="width: 80px; height: 80px; background: #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <span style="font-size: 24px;">üì∑</span>
            </div>
            <div style="flex-grow: 1;">
                <h3 style="margin: 0 0 5px 0; font-size: 0.9em; text-transform: uppercase;">Visual Context</h3>
                <div id="vision-details" style="font-size: 0.85em; opacity: 0.9;">
                    No image analyzed.
                </div>
                <div id="vision-warnings" style="color: var(--vscode-errorForeground); font-size: 0.85em; margin-top: 5px; display: none;"></div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button id="btn-use-reference" style="font-size: 0.8em; padding: 4px 8px; background: var(--vscode-button-secondaryBackground); color: var(--vscode-button-secondaryForeground); border: none; cursor: pointer;">Use as Reference</button>
                <button id="btn-discard-vision" class="secondary" style="font-size: 0.8em; padding: 4px 8px;">‚úï Discard</button>
            </div>
        </div>
    </div>

    <!-- Camera Stream Section -->
    <div id="camera-stream-container" style="padding: 15px 20px; border-bottom: 1px solid var(--vscode-panel-border); background: #000; display: none; flex-direction: column; align-items: center;">
        <div style="width: 100%; display: flex; justify-content: flex-end; margin-bottom: 5px;">
             <button id="btn-close-stream" style="background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer;" title="Close Camera">‚úï</button>
        </div>
        <img id="camera-stream-img" style="width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #333;" />
        <button id="btn-capture-stream" style="margin-top: 10px; width: 100%;">Capture Photo</button>
        <p style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">Native Python Stream</p>
    </div>

    <!-- Firmware Deployment Section -->
    <div id="firmware-container" style="padding: 15px 20px; border-bottom: 1px solid var(--vscode-panel-border); background: var(--vscode-editor-background); display: flex; flex-direction: column; gap: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 0.9em; text-transform: uppercase;">Firmware Deployment</h3>
            <span id="deployment-status" style="font-size: 0.8em; opacity: 0.7;">Ready</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="btn-build" style="flex: 1;">Build Firmware</button>
            <button id="btn-flash" style="flex: 1;" class="secondary">Flash to Device</button>
        </div>
    </div>

    <!-- Serial Diagnostics Section -->
    <div id="serial-container" style="padding: 15px 20px; border-bottom: 1px solid var(--vscode-panel-border); background: var(--vscode-sideBar-background); display: flex; flex-direction: column; gap: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 0.9em; text-transform: uppercase;">Serial Diagnostics</h3>
            <span id="serial-status" style="font-size: 0.8em; opacity: 0.7; color: var(--vscode-descriptionForeground);">Disconnected</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em;">
             <span>Buffered Lines:</span>
             <span id="serial-lines">0</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="btn-open-serial" style="flex: 1;">Open Monitor</button>
            <button id="btn-analyze-serial" style="flex: 1;" class="secondary">Analyze Logs</button>
        </div>
        <div id="serial-results" style="display: none; background: var(--vscode-editor-background); padding: 10px; border: 1px solid var(--vscode-panel-border); border-radius: 4px; font-size: 0.85em;">
            <!-- Analysis results go here -->
        </div>
    </div>


    <div id="result-stream">
        <!-- Initial State -->
        <div class="entry">
            <div class="entry-result">
                Ready for commands. Type <code>/help</code> for options.
            </div>
        </div>
    </div>

    <div id="command-bar">
        <div class="input-wrapper">
            <button id="btn-camera" style="margin-right: 8px; background: none; border: none; cursor: pointer; color: var(--vscode-foreground);" title="Upload Hardware Image">üì∑</button>
            <input type="file" id="file-input" accept="image/png, image/jpeg" style="display: none;" />
            <div id="autocomplete-list"></div>
            <input type="text" id="command-input" placeholder="Enter command (e.g., /analyze, /vision)..." autocomplete="off" />
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const input = document.getElementById('command-input');
        const stream = document.getElementById('result-stream');
        const autocompleteList = document.getElementById('autocomplete-list');
        const fileInput = document.getElementById('file-input');
        const btnCamera = document.getElementById('btn-camera');
        const visionContainer = document.getElementById('vision-container');
        const visionDetails = document.getElementById('vision-details');
        const visionThumb = document.getElementById('vision-thumb');
        const visionWarnings = document.getElementById('vision-warnings');
        const btnDiscardVision = document.getElementById('btn-discard-vision');
        const btnUseReference = document.getElementById('btn-use-reference');
        const modelSelect = document.getElementById('model-select');
        const modelRefresh = document.getElementById('model-refresh');
        const modelStatus = document.getElementById('model-status');
        
        const btnBuild = document.getElementById('btn-build');
        const btnFlash = document.getElementById('btn-flash');
        const deploymentStatus = document.getElementById('deployment-status');

        const btnOpenSerial = document.getElementById('btn-open-serial');
        const btnAnalyzeSerial = document.getElementById('btn-analyze-serial');
        const serialStatus = document.getElementById('serial-status');
        const serialLines = document.getElementById('serial-lines');
        const serialResults = document.getElementById('serial-results');

        const cameraStreamContainer = document.getElementById('camera-stream-container');
        const cameraStreamImg = document.getElementById('camera-stream-img');
        const btnCaptureStream = document.getElementById('btn-capture-stream');
        const btnCloseStream = document.getElementById('btn-close-stream');
        let currentStreamUrl = '';
        let modelRequestInFlight = false;

        // Listen for messages from extension (openCamera)
        window.addEventListener('message', event => {
            const message = event.data;
            if (message.type === 'visionResult') {
                cameraStreamContainer.style.display = 'none';
                updateVisionUI(message.data);
            }
            if (message.type === 'serialResult') {
                updateSerialUI(message.data);
            }
            if (message.type === 'serialStatus') {
                serialStatus.textContent = message.connected ? "Connected" : "Disconnected";
                serialStatus.style.color = message.connected ? "var(--vscode-testing-iconPassed)" : "var(--vscode-descriptionForeground)";
                serialLines.textContent = message.lineCount;
            }
            if (message.command === 'showStream') {
                currentStreamUrl = message.url;
                cameraStreamImg.src = message.url + '/stream';
                cameraStreamContainer.style.display = 'flex';
                // Hide vision result while streaming
                visionContainer.style.display = 'none';
            }
            // ... existing handlers ...
        });
        
        if (btnCaptureStream) {
            btnCaptureStream.addEventListener('click', () => {
                if (currentStreamUrl) {
                    btnCaptureStream.disabled = true;
                    btnCaptureStream.innerText = "Capturing...";
                    vscode.postMessage({ command: 'triggerCapture', url: currentStreamUrl });
                }
            });
        }
        
        if (btnCloseStream) {
            btnCloseStream.addEventListener('click', () => {
                cameraStreamContainer.style.display = 'none';
                cameraStreamImg.src = ''; // Stop trying to load
                vscode.postMessage({ command: 'stopStream' });
            });
        }

        function requestModels() {
            if (modelRequestInFlight) return;
            modelRequestInFlight = true;
            modelStatus.textContent = 'Loading...';
            vscode.postMessage({ command: 'getModels' });
        }

        if (modelRefresh) {
            modelRefresh.addEventListener('click', () => {
                requestModels();
            });
        }

        if (modelSelect) {
            modelSelect.addEventListener('change', () => {
                const value = modelSelect.value;
                if (value) {
                    vscode.postMessage({ command: 'setModel', model: value });
                }
            });
        }


        // Handle File Upload
        if (btnCamera) {
            btnCamera.addEventListener('click', () => {
                fileInput.click();
            });
        }

        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64 = event.target.result.split(',')[1];
                    
                    // Show loading state
                    visionContainer.style.display = 'block';
                    visionDetails.innerText = "Analyzing image...";
                    visionThumb.innerHTML = `<img src="${event.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    
                    vscode.postMessage({
                        command: 'analyzeImage',
                        base64: base64
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        if (btnDiscardVision) {
            btnDiscardVision.addEventListener('click', () => {
                visionContainer.style.display = 'none';
                fileInput.value = '';
                if (btnUseReference) {
                    btnUseReference.textContent = "Use as Reference";
                    btnUseReference.disabled = false;
                    btnUseReference.style.opacity = "1";
                }
                vscode.postMessage({ command: 'discardVision' });
            });
        }

        if (btnUseReference) {
            btnUseReference.addEventListener('click', () => {
                btnUseReference.textContent = "‚úì Active";
                btnUseReference.disabled = true;
                btnUseReference.style.opacity = "0.7";
                // Vision is already stored in backend, just visual confirmation
            });
        }

        if (btnBuild) {
            btnBuild.addEventListener('click', () => {
                deploymentStatus.textContent = "Building...";
                vscode.postMessage({ command: 'buildFirmware' });
            });
        }
        
        if (btnFlash) {
            btnFlash.addEventListener('click', () => {
                deploymentStatus.textContent = "Starting Flash...";
                vscode.postMessage({ command: 'flashFirmware' });
            });
        }

        if (btnOpenSerial) {
            btnOpenSerial.addEventListener('click', () => {
                vscode.postMessage({ command: 'executeCommand', text: 'aria.openSerialMonitor' });
            });
        }

        if (btnAnalyzeSerial) {
            btnAnalyzeSerial.addEventListener('click', () => {
                serialResults.style.display = 'block';
                serialResults.innerHTML = '<em>Analyzing...</em>';
                vscode.postMessage({ command: 'executeCommand', text: 'aria.analyzeSerialLogs' });
            });
        }

        function updateSerialUI(data) {
            serialResults.style.display = 'block';
            let html = '';
            
            if (data.thoughtProcess) {
                html += `
                    <div class="thought-process-container">
                        <details open>
                        <summary class="thought-process-header">
                             <span class="status-dot"></span> üß† Thinking Process
                        </summary>
                            <div class="thought-process-content" open>
                                ${data.thoughtProcess.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                        </details>
                    </div>
                `;
            }

            // Since we moved to plain text output, we rely on the thoughtProcess above to show the main content.
            // If there are legacy structured fields (suspectedIssues, etc.), we can still show them below,
            // but for the new flow, thoughtProcess contains everything.

            if (data.confidence !== undefined && data.confidence < 1.0) {
                 html += `<div style="margin-top: 5px; font-size: 0.8em; opacity: 0.8;">Confidence: ${(data.confidence * 100).toFixed(0)}%</div>`;
            }

            if (data.suspectedIssues && data.suspectedIssues.length > 0) {
                html += `<div style="margin-top:5px; color: var(--vscode-errorForeground);"><strong>Issues:</strong></div>`;
                html += `<ul>${data.suspectedIssues.map(i => `<li>${i}</li>`).join('')}</ul>`;
            }

            if (data.likelyRootCauses && data.likelyRootCauses.length > 0) {
                html += `<div style="margin-top:5px;"><strong>Root Causes:</strong></div>`;
                html += `<ul>${data.likelyRootCauses.map(i => `<li>${i}</li>`).join('')}</ul>`;
            }

            if (data.suggestedFixes && data.suggestedFixes.length > 0) {
                html += `<div style="margin-top:5px;"><strong>Fixes:</strong></div>`;
                data.suggestedFixes.forEach(fix => {
                    html += `<div style="border: 1px solid var(--vscode-panel-border); padding: 5px; margin-top: 5px;">`;
                    html += `<div>${fix.description}</div>`;
                    if (fix.diff) {
                        html += `<button class="btn-preview-diff" data-diff="${encodeURIComponent(fix.diff)}" style="margin-top: 5px; font-size: 0.8em;">Preview Fix</button>`;
                    }
                    html += `</div>`;
                });
            }
            
            serialResults.innerHTML = html;

            // Re-attach diff listeners
            document.querySelectorAll('.btn-preview-diff').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const diff = decodeURIComponent(e.target.dataset.diff);
                    vscode.postMessage({ 
                        command: 'previewDiff', 
                        diff: diff 
                    });
                });
            });
        }

        function updateVisionUI(data) {
            visionContainer.style.display = 'block';
            
            // Reset button state
            if (btnUseReference) {
                btnUseReference.textContent = "Use as Reference";
                btnUseReference.disabled = false;
                btnUseReference.style.opacity = "1";
            }

            let html = `<strong>Boards:</strong> ${data.detectedBoards.join(', ') || 'None'}<br>`;
            html += `<strong>Components:</strong> ${data.detectedComponents.join(', ') || 'None'}<br>`;
            html += `<strong>Confidence:</strong> ${(data.confidence * 100).toFixed(0)}%`;
            
            visionDetails.innerHTML = html;

            if (data.mismatchWarning) {
                visionWarnings.style.display = 'block';
                visionWarnings.innerText = `‚ö†Ô∏è ${data.mismatchWarning}`;
            } else {
                visionWarnings.style.display = 'none';
            }
        }

        const AVAILABLE_COMMANDS = [
            '/analyze',
            '/selection',
            '/workspace',
            '/validate',
            '/capture',
            '/help'
        ];

        let currentFocus = -1;

        // Focus input on load
        input.focus();

        // Input Event for Autocomplete
        input.addEventListener('input', function(e) {
            const val = this.value;
            closeAllLists();
            if (!val || !val.startsWith('/')) { return false; }
            
            currentFocus = -1;
            
            // Filter commands
            const matches = AVAILABLE_COMMANDS.filter(cmd => cmd.toLowerCase().startsWith(val.toLowerCase()));
            
            if (matches.length > 0) {
                autocompleteList.style.display = 'block';
                matches.forEach(cmd => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    // Highlight match
                    item.innerHTML = `<strong>${cmd.substr(0, val.length)}</strong>${cmd.substr(val.length)}`;
                    item.innerHTML += `<input type='hidden' value='${cmd}'>`;
                    
                    item.addEventListener('click', function(e) {
                        input.value = this.getElementsByTagName('input')[0].value;
                        closeAllLists();
                        input.focus();
                    });
                    
                    autocompleteList.appendChild(item);
                });
            }
        });

        // Handle Keys (Enter, Up, Down)
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent submitting form if we select from list
                
                if (currentFocus > -1) {
                    if (autocompleteList.style.display !== 'none') {
                        const items = autocompleteList.getElementsByTagName('div');
                        if (items[currentFocus]) {
                            items[currentFocus].click();
                            return; // Don't send command yet, just select
                        }
                    }
                }
                
                const text = input.value.trim();
                if (text) {
                    closeAllLists();
                    sendCommand(text);
                    input.value = '';
                }
            } else if (e.key === 'ArrowDown') {
                currentFocus++;
                addActive(autocompleteList.getElementsByTagName('div'));
            } else if (e.key === 'ArrowUp') {
                currentFocus--;
                addActive(autocompleteList.getElementsByTagName('div'));
            } else if (e.key === 'Escape') {
                closeAllLists();
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("active");
            // Scroll to view
            x[currentFocus].scrollIntoView({ block: 'nearest' });
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("active");
            }
        }

        function closeAllLists(elmnt) {
            autocompleteList.innerHTML = '';
            autocompleteList.style.display = 'none';
        }

        // Close list when clicking elsewhere
        document.addEventListener("click", function (e) {
            if (e.target !== input && e.target !== autocompleteList) {
                closeAllLists();
            }
        });

        // Send to Extension
        function sendCommand(text) {
            // Optimistically show command
            addEntry(text, 'command');
            
            // Send to backend
            vscode.postMessage({
                command: 'executeCommand',
                text: text
            });
        }

        // Handle messages from Extension
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'modelList':
                    modelRequestInFlight = false;
                    modelSelect.innerHTML = '';
                    if (message.models && message.models.length > 0) {
                        message.models.forEach(m => {
                            const option = document.createElement('option');
                            option.value = m;
                            option.textContent = m;
                            modelSelect.appendChild(option);
                        });
                    }
                    if (message.selected) {
                        const exists = Array.from(modelSelect.options).some(o => o.value === message.selected);
                        if (!exists) {
                            const option = document.createElement('option');
                            option.value = message.selected;
                            option.textContent = message.selected;
                            modelSelect.appendChild(option);
                        }
                        modelSelect.value = message.selected;
                    }
                    modelStatus.textContent = message.error ? message.error : `${(message.models || []).length} models`;
                    break;
                case 'modelSelected':
                    modelStatus.textContent = `Selected ${message.model}`;
                    break;
                case 'addResult':
                    addEntry(message.text, 'result');
                    break;
                case 'showAnalysis':
                    renderAnalysis(message.data, message.metadata);
                    break;
                case 'showHardwareValidation':
                    renderHardwareValidation(message.data, message.metadata);
                    break;
                case 'visionResult':
                    updateVisionUI(message.data);
                    break;
                case 'buildStatus':
                    deploymentStatus.textContent = message.status === 'success' ? 'Build Success' : 'Build Failed';
                    break;
                case 'flashStatus':
                    deploymentStatus.textContent = message.status === 'success' ? 'Flash Success' : 'Flash Failed';
                    break;
                case 'analysisLoading':
                    addEntry('<em>Analyzing...</em>', 'result');
                    break;
                case 'analysisError':
                    addEntry(`<span style="color:var(--vscode-errorForeground)">Analysis Failed: ${message.error}</span>`, 'result');
                    break;
                case 'successMessage':
                    addEntry(`<div style="padding: 12px; background: var(--vscode-textBlockQuote-background); border-left: 4px solid var(--vscode-testing-iconPassed); border-radius: 4px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.2em;">${message.text}</span>
                    </div>`, 'result');
                    break;
            }
        });

        function addEntry(text, type) {
            const div = document.createElement('div');
            div.className = 'entry';
            
            if (type === 'command') {
                const cmdDiv = document.createElement('div');
                cmdDiv.className = 'entry-command';
                cmdDiv.textContent = text;
                div.appendChild(cmdDiv);
            } else {
                const resDiv = document.createElement('div');
                resDiv.className = 'entry-result';
                resDiv.innerHTML = text; // Allow simple HTML
                div.appendChild(resDiv);
            }
            
            stream.appendChild(div);
            stream.scrollTop = stream.scrollHeight;
        }

        function renderAnalysis(analysis, metadata) {
            const container = document.createElement('div');
            container.className = 'entry';
            
            const card = document.createElement('div');
            card.className = 'entry-result analysis-card';
            
            // Header
            card.innerHTML = `
                <h3>${metadata.source === 'selection' ? 'üîé Selection' : metadata.source === 'workspace' ? 'üìÇ Workspace' : 'üìÑ File'}: ${metadata.filePath}</h3>
                <p>${analysis.summary}</p>
                
                ${analysis.thoughtProcess ? `
                <div class="analysis-section">
                    <details open>
                        <summary style="cursor: pointer; font-weight: bold; color: var(--vscode-descriptionForeground); display: flex; align-items: center; gap: 5px;">
                             <span class="status-dot" style="background-color: var(--vscode-charts-blue);"></span> üß† ${metadata.model || 'Gemini'} Thinking Process
                        </summary>
                        <div style="margin-top: 10px; padding: 10px; background: var(--vscode-editor-inactiveSelectionBackground); border-left: 2px solid var(--vscode-charts-blue); border-radius: 0 4px 4px 0; font-family: var(--vscode-editor-font-family); white-space: pre-wrap; font-size: 0.9em; max-height: 300px; overflow-y: auto; color: var(--vscode-editor-foreground);">
                            ${analysis.thoughtProcess.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                        </div>
                    </details>
                </div>` : ''}

                <div class="analysis-section">
                    <strong>‚ö†Ô∏è Issues (${analysis.detectedIssues.length})</strong>
                    <ul>${analysis.detectedIssues.map(i => `<li>${i}</li>`).join('')}</ul>
                </div>
                
                <div class="analysis-section">
                    <strong>üí° Recommendations</strong>
                    <ul>${analysis.recommendations.map(r => `<li>${r}</li>`).join('')}</ul>
                </div>
            `;

            // Suggestions
            if (analysis.suggestions && analysis.suggestions.length > 0) {
                const bulkActions = document.createElement('div');
                bulkActions.className = 'analysis-section';
                
                const applyAllBtn = document.createElement('button');
                applyAllBtn.textContent = 'Apply All Fixes';
                applyAllBtn.onclick = () => {
                    vscode.postMessage({
                        command: 'applyAllDiffs',
                        diffs: analysis.suggestions.map(s => s.diff)
                    });
                };
                
                bulkActions.appendChild(applyAllBtn);
                card.appendChild(bulkActions);

                const suggestionsTitle = document.createElement('div');
                suggestionsTitle.className = 'analysis-section';
                suggestionsTitle.innerHTML = `<strong>‚ú® Code Suggestions (${analysis.suggestions.length})</strong>`;
                card.appendChild(suggestionsTitle);

                analysis.suggestions.forEach((suggestion, index) => {
                    const sItem = document.createElement('div');
                    sItem.className = 'suggestion-item';
                    
                    const sHeader = document.createElement('div');
                    sHeader.className = 'suggestion-header';
                    
                    const fileBadge = suggestion.filePath 
                        ? `<span style="font-size:0.8em; opacity:0.7; margin-right:8px; background:var(--vscode-badge-background); color:var(--vscode-badge-foreground); padding:2px 4px; border-radius:3px;">${suggestion.filePath}</span>` 
                        : '';
                        
                    sHeader.innerHTML = `<div style="display:flex; align-items:center; overflow:hidden; text-overflow:ellipsis;">${fileBadge}<span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${suggestion.description}</span></div> <span>‚ñº</span>`;
                    sHeader.onclick = () => {
                        const body = sItem.querySelector('.suggestion-body');
                        body.classList.toggle('open');
                        sHeader.querySelector('span:last-child').textContent = body.classList.contains('open') ? '‚ñ≤' : '‚ñº';
                    };

                    const sBody = document.createElement('div');
                    sBody.className = 'suggestion-body';
                    
                    const actions = document.createElement('div');
                    actions.className = 'suggestion-actions';
                    
                    const btnPreview = document.createElement('button');
                    btnPreview.textContent = 'Preview Diff';
                    btnPreview.onclick = () => {
                        vscode.postMessage({
                            command: 'previewDiff',
                            diff: suggestion.diff
                        });
                    };

                    actions.appendChild(btnPreview);
                    
                    sBody.appendChild(actions);
                    sItem.appendChild(sHeader);
                    sItem.appendChild(sBody);
                    card.appendChild(sItem);
                });
            }

            // Footer
            const footer = document.createElement('div');
            footer.className = 'analysis-meta';
            footer.innerHTML = `Confidence: ${(analysis.confidence * 100).toFixed(0)}% | Hardware: ${metadata.hardware || "None"}`;
            card.appendChild(footer);

            container.appendChild(card);
            stream.appendChild(container);
            stream.scrollTop = stream.scrollHeight;
        }

        requestModels();

        function renderHardwareValidation(result, metadata) {
            const container = document.createElement('div');
            container.className = 'entry';
            
            const card = document.createElement('div');
            card.className = 'entry-result analysis-card';
            
            // Header
            card.innerHTML = `
                <h3>üõ†Ô∏è Hardware Validation</h3>
                <p><strong>Board:</strong> ${metadata.board}</p>
                <div style="margin-bottom: 10px;">
                    <span style="font-weight: bold; color: ${result.status === 'pass' ? 'var(--vscode-testing-iconPassed)' : result.status === 'fail' ? 'var(--vscode-testing-iconFailed)' : 'var(--vscode-charts-yellow)'}; text-transform: uppercase;">
                        Status: ${result.status}
                    </span>
                </div>
                
                <div class="analysis-section">
                    <strong>‚ö†Ô∏è Issues (${result.issues.length})</strong>
                    <ul>${result.issues.length > 0 ? result.issues.map(i => `<li>${i}</li>`).join('') : '<li>None detected.</li>'}</ul>
                </div>

                 <div class="analysis-section">
                    <strong>üîå Peripherals Detected</strong>
                    <ul>${result.peripherals.length > 0 ? result.peripherals.map(p => `<li>${p}</li>`).join('') : '<li>None detected.</li>'}</ul>
                </div>
                
                <div class="analysis-section" style="margin-top: 15px;">
                    <button id="btn-generate-sim" onclick="generateSimulation()">Generate Wokwi Simulation</button>
                    <button id="btn-open-sim" class="secondary" style="display:none;" onclick="openSimulation()">Open Simulation</button>
                </div>
            `;
            
            // Store data for callbacks
            card.dataset.result = JSON.stringify(result);
            card.dataset.metadata = JSON.stringify(metadata);

            container.appendChild(card);
            stream.appendChild(container);
            stream.scrollTop = stream.scrollHeight;
            
            // Bind data to window for the button functions to access last result (simple hack)
            window.lastValidationResult = result;
            window.lastValidationMetadata = metadata;
        }

        function generateSimulation() {
            if (!window.lastValidationResult) return;
            
            vscode.postMessage({
                command: 'generateSimulation',
                data: window.lastValidationResult,
                metadata: window.lastValidationMetadata
            });
            
            // Update UI
            const btnGen = document.getElementById('btn-generate-sim');
            if (btnGen) {
                btnGen.textContent = "Simulation Generated!";
                btnGen.disabled = true;
            }
            
            const btnOpen = document.getElementById('btn-open-sim');
            if (btnOpen) {
                btnOpen.style.display = 'inline-block';
            }
        }

        function openSimulation() {
             if (!window.lastValidationMetadata) return;
             
             vscode.postMessage({
                command: 'openSimulation',
                workspaceRoot: window.lastValidationMetadata.workspaceRoot
            });
        }
    </script>
</body>
</html>
