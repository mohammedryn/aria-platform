<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; connect-src http://127.0.0.1:*; frame-src http://127.0.0.1:*; img-src vscode-resource: https: data: blob: http://127.0.0.1:*; script-src 'unsafe-inline'; style-src 'unsafe-inline'; media-src vscode-resource: https: data: blob: mediastream: http://127.0.0.1:*;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.R.I.A. Copilot - Minecraft Style</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            /* Minecraft Palette */
            --mc-bg: #1e1e1e;
            /* Obsidian/Deep Background */
            --mc-stone: #c6c6c6;
            /* Stone Grey for UI elements */
            --mc-stone-dark: #8b8b8b;
            /* Darker Stone */
            --mc-dirt: #5d4037;
            /* Dirt Brown */
            --mc-text: #333333;
            /* Main text usually black on stone */
            --mc-text-light: #ffffff;
            /* Text on dark backgrounds */

            --font-pixel: 'Press Start 2P', cursive;
        }

        * {
            box-sizing: border-box;
            image-rendering: pixelated;
        }

        body {
            font-family: var(--font-pixel);
            color: var(--mc-text);
            background-color: #101010;
            /* Dark background behind panel */
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            font-size: 10px;
            line-height: 1.5;
        }

        /* Minecraft Scrollbar */
        ::-webkit-scrollbar {
            width: 16px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
            border-left: 2px solid #555;
        }

        ::-webkit-scrollbar-thumb {
            background: #c6c6c6;
            border: 2px solid #fff;
            box-shadow: inset -2px -2px 0 #555;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #dcdcdc;
        }

        /* Layout */
        header {
            background: var(--mc-stone);
            padding: 12px 16px;
            border-bottom: 4px solid #000;
            box-shadow: inset 0 -4px 0 rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            z-index: 10;
        }

        h1 {
            font-size: 1.2em;
            margin: 0;
            color: #333;
            text-shadow: 2px 2px 0 #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2 {
            font-size: 0.7em;
            color: #555;
            margin: 4px 0 0 0;
            font-weight: normal;
        }

        /* Generic Container Reset */
        .mc-container {
            padding: 15px 20px;
            background: var(--mc-stone);
            border-bottom: 4px solid #000;
            box-shadow: inset 2px 2px 0 #fff, inset -2px -2px 0 #555;
        }

        /* History Drawer - Inventory Style */
        #history-drawer {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: #c6c6c6;
            border-right: 4px solid #000;
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.2s steps(4);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 0 rgba(0, 0, 0, 0.5);
            padding: 4px;
        }

        #history-drawer.open {
            transform: translateX(0);
        }

        #history-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: none;
        }

        #history-overlay.open {
            display: block;
        }

        .history-header {
            background: #8b8b8b;
            padding: 10px;
            border: 2px solid #373737;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        .history-item {
            padding: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            color: #333;
            font-weight: bold;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid #fff;
        }

        /* Buttons - Classic Minecraft Style */
        button {
            background: #c6c6c6;
            color: #333;
            text-shadow: 1px 1px 0 #fff;
            font-family: var(--font-pixel);
            font-size: 10px;
            border: 2px solid #000;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #555;
            border-bottom: 2px solid #555;
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: none;
            border-radius: 0;
            margin-right: 4px;
            text-transform: uppercase;
        }

        button:hover {
            background: #dcdcdc;
            color: #5555ff;
            /* Highlight color */
            text-shadow: 1px 1px 0 #ccc;
        }

        button:active {
            border-top: 2px solid #555;
            border-left: 2px solid #555;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            background: #8b8b8b;
        }

        button.active {
            background: #8b8b8b;
            color: #55ff55;
            border-top: 2px solid #555;
            border-left: 2px solid #555;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
        }

        button.secondary {
            background: #a0a0a0;
        }

        /* Result Stream */
        #result-stream {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            background: rgba(0, 0, 0, 0.6);
            /* Darkened main area */
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0, 0, 0, 0.1) 10px, rgba(0, 0, 0, 0.1) 20px);
        }

        .entry {
            margin-bottom: 16px;
        }

        .entry-command {
            background: #212121;
            color: #fff;
            border: 2px solid #fff;
            padding: 8px 12px;
            display: inline-block;
            margin-bottom: 8px;
            font-size: 0.9em;
            box-shadow: 4px 4px 0 #000;
        }

        .entry-result {
            color: #ddd;
            font-family: 'Consolas', monospace;
            /* Keep readable */
            font-size: 1.1em;
            text-shadow: 1px 1px 0 #000;
        }

        /* Analysis Cards (Stone Slab) */
        .analysis-card {
            background: #c6c6c6;
            color: #333;
            border: 2px solid #000;
            box-shadow: inset 2px 2px 0 #fff, inset -2px -2px 0 #555;
            padding: 12px;
            margin-top: 8px;
            font-family: var(--font-pixel);
            font-size: 0.9em;
            text-shadow: none;
        }

        .analysis-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            text-shadow: 1px 1px 0 #fff;
            border-bottom: 2px solid #777;
            padding-bottom: 4px;
        }

        .analysis-section {
            background: #d6d6d6;
            border: 2px solid #777;
            padding: 8px;
            margin: 8px 0;
            box-shadow: inset 1px 1px 0 #555;
        }

        .analysis-section strong {
            color: #222;
        }

        .analysis-section ul {
            padding-left: 20px;
            margin: 4px 0;
        }

        /* Command Input (Chat) */
        #command-bar {
            background: #c6c6c6;
            padding: 10px;
            border-top: 4px solid #000;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="text"] {
            width: 100%;
            background: #000;
            color: #fff;
            font-family: var(--font-pixel);
            font-size: 11px;
            padding: 12px;
            border: 2px solid #a0a0a0;
            outline: none;
            box-shadow: inset 2px 2px 0 #333;
        }

        input[type="text"]:focus {
            border-color: #fff;
        }

        /* Suggestions/Autofill */
        /* Suggestions/Autofill */
        #autocomplete-list {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: #1e1e1e;
            border: 2px solid #fff;
            border-bottom: none;
            z-index: 10000;
            margin-bottom: 0;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.5);
        }

        .input-wrapper {
            position: relative;
            /* Ensure absolute children are relative to this */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .autocomplete-item {
            padding: 8px;
            color: #aaa;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }

        .autocomplete-item:hover,
        .autocomplete-item.active {
            background: #333;
            color: #fff;
        }

        /* Code Blocks */
        code {
            font-family: 'Consolas', monospace;
            background: #333;
            color: #ddd;
            padding: 2px 4px;
            border: 1px solid #555;
        }

        /* Status Dot */
        .status-dot {
            height: 10px;
            width: 10px;
            background: #55ff55;
            display: inline-block;
            margin-right: 8px;
            border: 2px solid #000;
            box-shadow: none;
            animation: none;
        }

        /* Fix Card (Suggestion) */
        .fix-card {
            background: #e6e6e6;
            border: 2px dashed #555;
            padding: 8px;
            margin-top: 8px;
        }

        /* Helper for Overrides */
        #model-container,
        #vision-container,
        #video-context-container,
        #firmware-container,
        #serial-container {
            background: #c6c6c6 !important;
            border-bottom: 4px solid #000 !important;
            color: #333 !important;
            box-shadow: inset 2px 2px 0 #fff, inset -2px -2px 0 #555;
        }

        /* Dropdowns */
        select {
            background: #8b8b8b;
            color: #fff;
            border: 2px solid #000;
            box-shadow: inset -2px -2px 0 #fff;
            padding: 4px;
            font-family: var(--font-pixel);
            font-size: 10px;
        }
    </style>
</head>

<body>
    <div id="history-overlay"></div>
    <div id="history-drawer">
        <div class="history-header">
            <span style="font-weight: 600;">Chat History</span>
            <button id="btn-close-history" style="background:none; border:none; padding:0; box-shadow:none;">‚úï</button>
        </div>
        <div style="padding: 10px;">
            <button id="btn-new-chat" style="width: 100%;">+ New Chat</button>
        </div>
        <div id="history-list" class="history-list">
            <!-- Items go here -->
        </div>
    </div>
    <header>
        <div style="display: flex; align-items: center;">
            <button id="btn-toggle-history" style="font-size:1.2em; margin-right:10px; padding: 4px 8px;">‚ò∞</button>
            <div>
                <h1><span class="status-dot"></span>A.R.I.A. Copilot</h1>
                <h2>Minecraft Edition</h2>
            </div>
        </div>
    </header>
    <div id="model-container" class="mc-container">
        <span style="font-size: 0.85em; opacity: 0.8; font-weight: bold;">Model</span>
        <select id="model-select" style="flex: 1; margin: 0 8px;"></select>
        <button id="model-refresh" class="secondary" style="padding: 6px 10px;">Refresh</button>
        <span id="model-status" style="font-size: 0.8em; opacity: 0.7; margin-left: 8px;"></span>
    </div>

    <!-- Visual Hardware Context Section -->
    <div id="vision-container" style="display: none;" class="mc-container">
        <div style="display: flex; gap: 15px; align-items: flex-start;">
            <div id="vision-thumb"
                style="width: 80px; height: 80px; background: #333; border: 2px solid #000; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <span style="font-size: 24px;">üì∑</span>
            </div>
            <div style="flex-grow: 1;">
                <h3 style="margin: 0 0 5px 0; font-size: 0.9em; text-transform: uppercase; color: #333;">Visual Context
                </h3>
                <div id="vision-details" style="font-size: 0.85em; opacity: 0.9;">
                    No image analyzed.
                </div>
                <div id="vision-warnings" style="color: #d32f2f; font-size: 0.85em; margin-top: 5px; display: none;">
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button id="btn-use-reference">Use as Reference</button>
                <button id="btn-discard-vision" class="secondary">‚úï Discard</button>
            </div>
        </div>
    </div>

    <!-- Video Context Section -->
    <div id="video-context-container" style="display: none;" class="mc-container">
        <div style="display: flex; gap: 15px; align-items: flex-start;">
            <div id="video-thumb"
                style="width: 80px; height: 80px; background: #222; border: 2px solid #000; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <span style="font-size: 24px;">üé•</span>
            </div>
            <div style="flex-grow: 1;">
                <h3 style="margin: 0 0 5px 0; font-size: 0.9em; text-transform: uppercase;">Video Context</h3>
                <div id="video-details" style="font-size: 0.85em; opacity: 0.9;">
                    No video selected.
                </div>
                <div id="video-status" style="color: #0000aa; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button id="btn-analyze-video" style="display: none;">Analyze</button>
                <button id="btn-discard-video" class="secondary">‚úï Discard</button>
            </div>
        </div>
    </div>

    <!-- Camera Stream Section -->
    <div id="camera-stream-container"
        style="padding: 15px 20px; border-bottom: 4px solid #000; background: #000; display: none; flex-direction: column; align-items: center;">
        <div style="width: 100%; display: flex; justify-content: flex-end; margin-bottom: 5px;">
            <button id="btn-close-stream" style="color: #fff; background: #d32f2f;" title="Close Camera">‚úï</button>
        </div>
        <img id="camera-stream-img"
            style="width: 100%; max-height: 300px; object-fit: contain; border: 4px solid #8b8b8b;" />

        <!-- Photo Mode Controls -->
        <button id="btn-capture-stream" style="margin-top: 10px; width: 100%;">Capture Photo</button>

        <!-- Video Mode Controls -->
        <div id="video-controls-container" style="width: 100%; display: none; margin-top: 10px; gap: 10px;">
            <button id="btn-record-start" style="flex: 1; color: #fff; background: #d32f2f;">Start Recording</button>
            <button id="btn-record-stop" style="flex: 1; display: none;">Stop Recording</button>
        </div>

        <p style="font-size: 0.8em; opacity: 0.7; margin-top: 5px; color: #ccc;">Native Python Stream</p>
    </div>

    <!-- Firmware Deployment Section -->
    <div id="firmware-container" class="mc-container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 0.9em; text-transform: uppercase; color: #333;">Firmware Deployment</h3>
            <span id="deployment-status" style="font-size: 0.8em; opacity: 0.7;">Ready</span>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="btn-build" style="flex: 1;">Build Firmware</button>
            <button id="btn-flash" style="flex: 1;" class="secondary">Flash to Device</button>
        </div>
    </div>

    <!-- Serial Diagnostics Section -->
    <div id="serial-container" class="mc-container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 0.9em; text-transform: uppercase; color: #333;">Serial Diagnostics</h3>
            <span id="serial-status" style="font-size: 0.8em; opacity: 0.7;">Disconnected</span>
        </div>
        <div
            style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; margin-top: 5px; color: #444;">
            <span>Buffered Lines:</span>
            <span id="serial-lines">0</span>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="btn-open-serial" style="flex: 1;">Open Monitor</button>
            <button id="btn-analyze-serial" style="flex: 1;" class="secondary">Analyze Logs</button>
        </div>
        <div id="serial-results"
            style="display: none; background: #eee; padding: 10px; border: 2px solid #555; margin-top: 10px; font-size: 0.85em; color: #333;">
            <!-- Analysis results go here -->
        </div>
    </div>


    <div id="result-stream">
        <!-- Initial State -->
        <div class="entry">
            <div class="entry-result" style="color: #fff; text-shadow: 1px 1px 0 #000;">
                Ready for commands. Type <code style="color: #fff;">/help</code> for options.
            </div>
        </div>
    </div>

    <div id="command-bar">
        <div class="input-wrapper">
            <button id="btn-camera" title="Upload Hardware Image">üì∑</button>
            <button id="btn-video" title="Analyze Hardware Video">üé•</button>
            <input type="file" id="file-input" accept="image/png, image/jpeg" style="display: none;" />
            <div id="autocomplete-list"></div>
            <input type="text" id="command-input" placeholder="Enter command (e.g., /analyze, /vision)..."
                autocomplete="off" />
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const input = document.getElementById('command-input');
        const stream = document.getElementById('result-stream');

        // Restore State immediately
        const previousState = vscode.getState();
        if (previousState && previousState.chatHtml) {
            stream.innerHTML = previousState.chatHtml;
            // Scroll to bottom
            setTimeout(() => stream.scrollTop = stream.scrollHeight, 100);
        }

        function saveState() {
            vscode.setState({ chatHtml: stream.innerHTML });
        }
        const autocompleteList = document.getElementById('autocomplete-list');
        const fileInput = document.getElementById('file-input');
        const btnCamera = document.getElementById('btn-camera');
        const btnVideo = document.getElementById('btn-video');

        const visionContainer = document.getElementById('vision-container');
        const visionDetails = document.getElementById('vision-details');
        const visionThumb = document.getElementById('vision-thumb');
        const visionWarnings = document.getElementById('vision-warnings');
        const btnDiscardVision = document.getElementById('btn-discard-vision');
        const btnUseReference = document.getElementById('btn-use-reference');

        const videoContextContainer = document.getElementById('video-context-container');
        const videoDetails = document.getElementById('video-details');
        const videoStatus = document.getElementById('video-status');
        const btnAnalyzeVideo = document.getElementById('btn-analyze-video');
        const btnDiscardVideo = document.getElementById('btn-discard-video');

        const modelSelect = document.getElementById('model-select');
        const modelRefresh = document.getElementById('model-refresh');
        const modelStatus = document.getElementById('model-status');

        const btnBuild = document.getElementById('btn-build');
        const btnFlash = document.getElementById('btn-flash');
        const deploymentStatus = document.getElementById('deployment-status');

        const btnOpenSerial = document.getElementById('btn-open-serial');
        const btnAnalyzeSerial = document.getElementById('btn-analyze-serial');
        const serialStatus = document.getElementById('serial-status');
        const serialLines = document.getElementById('serial-lines');
        const serialResults = document.getElementById('serial-results');

        const cameraStreamContainer = document.getElementById('camera-stream-container');
        const cameraStreamImg = document.getElementById('camera-stream-img');
        const btnCaptureStream = document.getElementById('btn-capture-stream');
        const btnCloseStream = document.getElementById('btn-close-stream');
        const videoControlsContainer = document.getElementById('video-controls-container');
        const btnRecordStart = document.getElementById('btn-record-start');
        const btnRecordStop = document.getElementById('btn-record-stop');
        let currentStreamUrl = '';
        let modelRequestInFlight = false;

        // History UI Elements
        const historyDrawer = document.getElementById('history-drawer');
        const historyOverlay = document.getElementById('history-overlay');
        const historyList = document.getElementById('history-list');
        const btnToggleHistory = document.getElementById('btn-toggle-history');
        const btnCloseHistory = document.getElementById('btn-close-history');
        const btnNewChat = document.getElementById('btn-new-chat');

        function toggleHistory(show) {
            if (show) {
                historyDrawer.classList.add('open');
                historyOverlay.classList.add('open');
                vscode.postMessage({ command: 'getHistory' });
            } else {
                historyDrawer.classList.remove('open');
                historyOverlay.classList.remove('open');
            }
        }

        btnToggleHistory.addEventListener('click', () => toggleHistory(true));
        btnCloseHistory.addEventListener('click', () => toggleHistory(false));
        historyOverlay.addEventListener('click', () => toggleHistory(false));

        btnNewChat.addEventListener('click', () => {
            toggleHistory(false);
            vscode.postMessage({ command: 'newChat' });
        });

        function renderHistoryList(sessions) {
            historyList.innerHTML = '';
            if (!sessions || sessions.length === 0) {
                historyList.innerHTML = '<div style="padding:10px; opacity:0.7;">No history</div>';
                return;
            }

            // Sort by last modified
            sessions.sort((a, b) => b.lastModified - a.lastModified);

            sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'history-item';

                const date = new Date(session.lastModified).toLocaleDateString();

                item.innerHTML = `
                    <div class="history-title">${session.title}</div>
                    <div class="history-date">${date}</div>
                    <button class="history-delete" title="Delete Chat">üóëÔ∏è</button>
                `;

                item.addEventListener('click', (e) => {
                    // Ignore if delete button clicked
                    if (e.target.classList.contains('history-delete')) return;
                    toggleHistory(false);
                    vscode.postMessage({ command: 'loadSession', sessionId: session.id });
                });

                const deleteBtn = item.querySelector('.history-delete');
                // Ensure button is above everything
                deleteBtn.style.zIndex = '100';
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('Delete clicked for', session.id);
                    // Direct send, confirm removed for testing/robustness
                    vscode.postMessage({ command: 'deleteChat', sessionId: session.id });
                    // Visual feedback
                    item.style.opacity = '0.5';
                });

                historyList.appendChild(item);
            });
        }

        function loadChatSession(session, isInit = false) {
            // Protection: If initializing
            if (isInit && stream.children.length > 0) {
                const first = stream.children[0];
                const isDefault = first.textContent.includes('Ready for commands');
                // If we have content that is NOT the default welcome message, preserve it.
                if (!isDefault || stream.children.length > 1) {
                    console.log('Skipping backend init load in favor of local state');
                    return;
                }
            }
            stream.innerHTML = '';
            // Reset state
            videoContextContainer.style.display = 'none';
            visionContainer.style.display = 'none';

            // Render messages
            session.messages.forEach(msg => {
                if (msg.role === 'user') {
                    // Check if it was a command or just text
                    const type = 'command';
                    addEntry(msg.content, type);
                } else if (msg.role === 'assistant') {
                    // Check metadata for rich content
                    if (msg.metadata) {
                        const m = msg.metadata;
                        if (m.type === 'showAnalysis') {
                            renderAnalysis(m.data, m.metadata);
                        } else if (m.type === 'visionResult') {
                            updateVisionUI(m.data);
                        } else if (m.type === 'addResult') {
                            addEntry(m.text, 'result');
                        } else if (m.type === 'showImage') {
                            // Re-use the existing showImage logic (which usually comes from 'message' event directly)
                            // We need to call showImage(m.image, m.isSvg, m.prompt)
                            showImage(m.image, m.isSvg, m.prompt);
                            // Scroll after image render
                            setTimeout(() => stream.scrollTop = stream.scrollHeight, 100);
                        } else if (m.type === 'simulationReady') {
                            addEntry(`<div style="padding: 10px; background: #2d2d2d; border: 1px solid #444; margin-top: 5px;">
                                <div style="color: #4caf50; font-weight: bold; margin-bottom: 5px;">‚úì Simulation Ready</div>
                                <div style="font-size: 0.9em; color: #ccc;">Generated Wokwi project in ${m.workspaceRoot}</div>
                            </div>`, 'result');
                        } else if (m.type === 'successMessage') {
                            addEntry(`<div style="padding: 12px; background: #e6e6e6; border-left: 4px solid #55ff55; color: #333; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.2em;">${m.text}</span>
                            </div>`, 'result');
                        } else if (m.type === 'analysisError') {
                            addEntry(`<span style="color:#ff5555">Analysis Failed: ${m.error}</span>`, 'result');
                        } else if (msg.content) {
                            // Fallback if metadata type not handled but content exists
                            addEntry(msg.content, 'result');
                        }
                    } else if (msg.content) {
                        addEntry(msg.content, 'result');
                    }
                }
            });

            // Scroll to bottom
            stream.scrollTop = stream.scrollHeight;
        }

        // Listen for messages from extension (openCamera)
        window.addEventListener('message', event => {
            const message = event.data;
            if (message.type === 'visionResult') {
                cameraStreamContainer.style.display = 'none';
                updateVisionUI(message.data);
            }
            if (message.type === 'videoSelected') {
                videoContextContainer.style.display = 'block';
                videoDetails.textContent = message.filename;
                videoStatus.textContent = 'Initializing Upload...';
                btnAnalyzeVideo.style.display = 'none';
            }
            if (message.type === 'loadChat') {
                loadChatSession(message.session);
            }
            if (message.type === 'videoStatus') {
                videoStatus.textContent = message.status;
                if (message.ready) {
                    btnAnalyzeVideo.style.display = 'inline-block';
                    videoStatus.style.color = '#00aa00';
                } else if (message.error) {
                    videoStatus.style.color = '#aa0000';
                } else {
                    videoStatus.style.color = '#0000aa';
                }
            }
            if (message.type === 'serialResult') {
                updateSerialUI(message.data);
            }
            if (message.type === 'serialStatus') {
                serialStatus.textContent = message.connected ? "Connected" : "Disconnected";
                serialStatus.style.color = message.connected ? "#00aa00" : "#555";
                serialLines.textContent = message.lineCount;
            }
            if (message.command === 'showStream') {
                currentStreamUrl = message.url;
                cameraStreamImg.src = message.url + '/stream';
                cameraStreamContainer.style.display = 'flex';
                // Hide vision result while streaming
                visionContainer.style.display = 'none';

                // Mode handling
                if (message.mode === 'video') {
                    btnCaptureStream.style.display = 'none';
                    videoControlsContainer.style.display = 'flex';
                    btnRecordStart.style.display = 'block';
                    btnRecordStop.style.display = 'none';
                } else {
                    btnCaptureStream.style.display = 'block';
                    videoControlsContainer.style.display = 'none';
                }
            }

            if (message.type === 'modelList') {
                modelRequestInFlight = false;
                modelSelect.innerHTML = '';
                if (message.models && message.models.length > 0) {
                    message.models.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m;
                        option.textContent = m;
                        modelSelect.appendChild(option);
                    });
                }
                if (message.selected) {
                    const exists = Array.from(modelSelect.options).some(o => o.value === message.selected);
                    if (!exists) {
                        const option = document.createElement('option');
                        option.value = message.selected;
                        option.textContent = message.selected;
                        modelSelect.appendChild(option);
                    }
                    modelSelect.value = message.selected;
                }
                modelStatus.textContent = message.error ? message.error : `${(message.models || []).length} models`;
            }

            if (message.type === 'modelSelected') {
                modelStatus.textContent = `Selected ${message.model}`;
            }

            if (message.type === 'addResult') {
                addEntry(message.text, 'result');
            }

            if (message.type === 'showAnalysis') {
                renderAnalysis(message.data, message.metadata);
            }

            if (message.type === 'showImage') {
                // Remove loading
                const loadingElements = document.querySelectorAll('.entry-result em');
                loadingElements.forEach(el => {
                    if (el.textContent === 'Analyzing...' || el.textContent.includes('Generating')) {
                        el.closest('.entry').remove();
                    }
                });

                const imgContainer = document.createElement('div');
                imgContainer.className = 'entry';

                let imageContent = '';
                if (message.isSvg) {
                    imageContent = `<div style="background: white; padding: 10px; border-radius: 4px; overflow: auto;">${message.image}</div>`;
                } else {
                    // Default to JPEG if no prefix, otherwise use as is
                    const src = message.image.startsWith('data:') ? message.image : `data:image/jpeg;base64,${message.image}`;
                    imageContent = `<img src="${src}" style="max-width: 100%; border: 1px solid #555; border-radius: 4px; margin-top: 10px;" />`;
                }

                imgContainer.innerHTML = `
                    <div class="entry-header">
                        <span>A.R.I.A (Schematic Engine)</span>
                    </div>
                    <div class="entry-result">
                        <p><strong>Generated Schematic:</strong> ${message.prompt}</p>
                        ${imageContent}
                        <div style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">Model: ${message.metadata.model}</div>
                    </div>
                `;
                stream.appendChild(imgContainer);
                stream.scrollTop = stream.scrollHeight;
            }

            if (message.type === 'showHardwareValidation') {
                renderHardwareValidation(message.data, message.metadata);
            }

            if (message.type === 'analysisLoading') {
                addEntry('<em>Analyzing...</em>', 'result');
            }

            if (message.type === 'analysisError') {
                addEntry(`<span style="color:#ff5555">Analysis Failed: ${message.error}</span>`, 'result');
            }

            if (message.type === 'successMessage') {
                addEntry(`<div style="padding: 12px; background: #e6e6e6; border-left: 4px solid #55ff55; color: #333; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">${message.text}</span>
                </div>`, 'result');
            }

            if (message.type === 'historyList') {
                renderHistoryList(message.sessions);
            }

            if (message.type === 'loadChat') {
                loadChatSession(message.session, message.isInit);
            }

            if (message.type === 'clearContext') {
                // Clear Vision UI
                visionContainer.style.display = 'none';
                visionDetails.innerText = "No image analyzed.";
                if (visionThumb) visionThumb.innerHTML = '<span style="font-size: 24px;">üì∑</span>';
                if (fileInput) fileInput.value = '';
                if (btnUseReference) {
                    btnUseReference.classList.remove('active');
                    btnUseReference.textContent = "Use as Reference";
                }
                // Clear Video UI
                videoContextContainer.style.display = 'none';
                if (videoDetails) videoDetails.textContent = "No video selected.";
            }
        });

        function addEntry(text, type) {
            const div = document.createElement('div');
            div.className = 'entry';

            if (type === 'command') {
                const cmdDiv = document.createElement('div');
                cmdDiv.className = 'entry-command';
                cmdDiv.textContent = text;
                div.appendChild(cmdDiv);
            } else {
                const resDiv = document.createElement('div');
                resDiv.className = 'entry-result';
                resDiv.innerHTML = text; // Allow simple HTML
                div.appendChild(resDiv);
            }

            stream.appendChild(div);
            stream.scrollTop = stream.scrollHeight;
            saveState(); // Persist
        }

        // ... (formatSimpleMarkdown omitted) ...

        function renderAnalysis(analysis, metadata) {
            // ... (existing logic) ...

            // At the end of renderAnalysis:
            container.appendChild(card);
            stream.appendChild(container);
            stream.scrollTop = stream.scrollHeight;
            saveState(); // Persist
        }

        // ...

        function renderHardwareValidation(result, metadata) {
            // ... (existing logic) ...

            // At the end:
            container.appendChild(card);
            stream.appendChild(container);
            stream.scrollTop = stream.scrollHeight;
            // Bind data to window for the button functions
            window.lastValidationResult = result;
            window.lastValidationMetadata = metadata;
            saveState(); // Persist
        }

        function formatSimpleMarkdown(text) {
            if (!text) return '';
            // 1. Escape HTML (basic)
            let html = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

            // 2. Bold (**text**)
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

            // 3. Italic (*text*)
            html = html.replace(/\*(.*?)\*/g, '<i>$1</i>');

            // 4. Code (`text`)
            html = html.replace(/`(.*?)`/g, '<code style="background:#444; color: #ddd; padding:2px 4px; border: 1px solid #666;">$1</code>');

            // 5. Headers (### Text) - convert to bold block
            html = html.replace(/^###\s+(.*$)/gm, '<div style="font-weight:600; margin-top:10px; margin-bottom:5px;">$1</div>');

            return html;
        }

        function renderAnalysis(analysis, metadata) {
            const container = document.createElement('div');
            container.className = 'entry';

            const card = document.createElement('div');
            card.className = 'entry-result analysis-card';

            // Header
            let headerHtml = '';
            if (metadata.source !== 'chat') {
                headerHtml = `<h3>${metadata.source === 'selection' ? 'üîé Selection' : metadata.source === 'workspace' ? 'üìÇ Workspace' : metadata.source === 'vision-chat' ? 'üëÅÔ∏è Vision Chat' : metadata.source === 'video-analysis' ? 'üé• Video Analysis' : 'üìÑ File'}: ${metadata.filePath || 'General Chat'}</h3>`;
            }

            card.innerHTML = `
                ${headerHtml}
                <div style="margin-bottom: 15px; font-size: 1.1em; line-height: 1.5; white-space: pre-wrap;">${formatSimpleMarkdown(analysis.summary)}</div>
                
                ${(analysis.thoughtProcess && metadata.source !== 'chat') ? `
                <div class="analysis-section">
                    <details>
                        <summary style="cursor: pointer; font-weight: bold; color: #555; display: flex; align-items: center; gap: 5px;">
                             <span class="status-dot"></span> üß† Thinking Process
                        </summary>
                        <div style="margin-top: 10px; padding: 10px; background: #e0e0e0; border-left: 2px solid #555; border-radius: 0 4px 4px 0; font-family: 'Press Start 2P', cursive; white-space: pre-wrap; font-size: 0.9em; max-height: 300px; overflow-y: auto; color: #333;">
                            ${analysis.thoughtProcess.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                        </div>
                    </details>
                </div>` : ''}

                ${(analysis.detectedIssues && analysis.detectedIssues.length > 0) ? `
                <div class="analysis-section">
                    <strong>‚ö†Ô∏è Issues (${analysis.detectedIssues.length})</strong>
                    <ul>${analysis.detectedIssues.map(i => `<li>${i}</li>`).join('')}</ul>
                </div>` : ''}
                
                ${(analysis.recommendations && analysis.recommendations.length > 0) ? `
                <div class="analysis-section">
                    <strong>üí° Recommendations</strong>
                    <ul>${analysis.recommendations.map(r => `<li>${r}</li>`).join('')}</ul>
                </div>` : ''}
            `;

            // Suggestions
            if (analysis.suggestions && analysis.suggestions.length > 0) {
                const bulkActions = document.createElement('div');
                bulkActions.className = 'analysis-section';

                const applyAllBtn = document.createElement('button');
                applyAllBtn.textContent = 'Apply All Fixes';
                applyAllBtn.onclick = () => {
                    vscode.postMessage({
                        command: 'applyAllDiffs',
                        diffs: analysis.suggestions.map(s => s.diff)
                    });
                };

                bulkActions.appendChild(applyAllBtn);
                card.appendChild(bulkActions);

                const suggestionsTitle = document.createElement('div');
                suggestionsTitle.className = 'analysis-section';
                suggestionsTitle.innerHTML = `<strong>‚ú® Code Suggestions (${analysis.suggestions.length})</strong>`;
                card.appendChild(suggestionsTitle);

                analysis.suggestions.forEach((suggestion, index) => {
                    const sItem = document.createElement('div');
                    sItem.className = 'suggestion-item';

                    const sHeader = document.createElement('div');
                    sHeader.className = 'suggestion-header';

                    const fileBadge = suggestion.filePath
                        ? `<span style="font-size:0.8em; opacity:0.7; margin-right:8px; background:#555; color:#fff; padding:2px 4px;">${suggestion.filePath}</span>`
                        : '';

                    sHeader.innerHTML = `<div style="display:flex; align-items:center; overflow:hidden; text-overflow:ellipsis;">${fileBadge}<span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${suggestion.description}</span></div> <span>‚ñº</span>`;
                    sHeader.onclick = () => {
                        const body = sItem.querySelector('.suggestion-body');
                        body.classList.toggle('open');
                        sHeader.querySelector('span:last-child').textContent = body.classList.contains('open') ? '‚ñ≤' : '‚ñº';
                    };

                    const sBody = document.createElement('div');
                    sBody.className = 'suggestion-body';

                    const actions = document.createElement('div');
                    actions.className = 'suggestion-actions';

                    const btnPreview = document.createElement('button');
                    btnPreview.textContent = 'Preview Diff';
                    btnPreview.onclick = () => {
                        vscode.postMessage({
                            command: 'previewDiff',
                            diff: suggestion.diff
                        });
                    };

                    actions.appendChild(btnPreview);

                    sBody.appendChild(actions);
                    sItem.appendChild(sHeader);
                    sItem.appendChild(sBody);
                    card.appendChild(sItem);
                });
            }

            // Footer
            const footer = document.createElement('div');
            footer.className = 'analysis-meta';
            footer.innerHTML = `Confidence: ${(analysis.confidence * 100).toFixed(0)}% | Hardware: ${metadata.hardware || "None"}`;
            card.appendChild(footer);

            container.appendChild(card);
            stream.appendChild(container);
            stream.scrollTop = stream.scrollHeight;
        }

        requestModels();

        function requestModels() {
            modelStatus.innerText = "Loading...";
            modelRequestInFlight = true;
            vscode.postMessage({ command: 'getModels' });
        }

        modelRefresh.addEventListener('click', () => {
            if (!modelRequestInFlight) requestModels();
        });

        if (modelSelect) {
            modelSelect.addEventListener('change', () => {
                const value = modelSelect.value;
                if (value) {
                    vscode.postMessage({ command: 'setModel', model: value });
                }
            });
        }

        function renderHardwareValidation(result, metadata) {
            const container = document.createElement('div');
            container.className = 'entry';

            const card = document.createElement('div');
            card.className = 'entry-result analysis-card';

            // Header
            card.innerHTML = `
                <h3>üõ†Ô∏è Hardware Validation</h3>
                <p><strong>Board:</strong> ${metadata.board}</p>
                <div style="margin-bottom: 10px;">
                    <span style="font-weight: bold; color: ${result.status === 'pass' ? '#55ff55' : result.status === 'fail' ? '#ff5555' : '#ffff55'}; text-transform: uppercase;">
                        Status: ${result.status}
                    </span>
                </div>
                
                ${(result.issues && result.issues.length > 0) ? `
                <div class="analysis-section">
                    <strong>‚ö†Ô∏è Issues (${result.issues.length})</strong>
                    <ul>${result.issues.map(i => `<li>${i}</li>`).join('')}</ul>
                </div>` : ''}

                ${(result.peripherals && result.peripherals.length > 0) ? `
                 <div class="analysis-section">
                    <strong>üîå Peripherals Detected</strong>
                    <ul>${result.peripherals.map(p => `<li>${p}</li>`).join('')}</ul>
                </div>` : ''}
                
                <div class="analysis-section" style="margin-top: 15px;">
                    <button id="btn-generate-sim" onclick="generateSimulation()">Generate Wokwi Simulation</button>
                    <button id="btn-open-sim" class="secondary" style="display:none;" onclick="openSimulation()">Open Simulation</button>
                </div>
            `;

            // Store data for callbacks
            card.dataset.result = JSON.stringify(result);
            card.dataset.metadata = JSON.stringify(metadata);

            container.appendChild(card);
            stream.appendChild(container);
            stream.scrollTop = stream.scrollHeight;

            // Bind data to window for the button functions to access last result (simple hack)
            window.lastValidationResult = result;
            window.lastValidationMetadata = metadata;
        }

        function generateSimulation() {
            if (!window.lastValidationResult) return;

            vscode.postMessage({
                command: 'generateSimulation',
                data: window.lastValidationResult,
                metadata: window.lastValidationMetadata
            });

            // Update UI
            const btnGen = document.getElementById('btn-generate-sim');
            if (btnGen) {
                btnGen.textContent = "Simulation Generated!";
                btnGen.disabled = true;
            }

            const btnOpen = document.getElementById('btn-open-sim');
            if (btnOpen) {
                btnOpen.style.display = 'inline-block';
            }
        }

        function openSimulation() {
            if (!window.lastValidationMetadata) return;

            vscode.postMessage({
                command: 'openSimulation',
                workspaceRoot: window.lastValidationMetadata.workspaceRoot
            });
        }

        // Handle Video Interaction
        if (btnVideo) {
            btnVideo.addEventListener('click', () => {
                vscode.postMessage({ command: 'selectVideo' });
            });
        }

        if (btnAnalyzeVideo) {
            btnAnalyzeVideo.addEventListener('click', () => {
                vscode.postMessage({ command: 'analyzeVideo' });
            });
        }

        if (btnDiscardVideo) {
            btnDiscardVideo.addEventListener('click', () => {
                videoContextContainer.style.display = 'none';
                vscode.postMessage({ command: 'discardVideo' });
            });
        }

        // Camera Stream Controls
        if (btnCaptureStream) {
            btnCaptureStream.addEventListener('click', () => {
                // Capture image from stream
                const canvas = document.createElement('canvas');
                canvas.width = cameraStreamImg.naturalWidth;
                canvas.height = cameraStreamImg.naturalHeight;
                canvas.getContext('2d').drawImage(cameraStreamImg, 0, 0);
                const base64 = canvas.toDataURL('image/jpeg').split(',')[1];

                // Stop stream
                cameraStreamContainer.style.display = 'none';
                cameraStreamImg.src = '';
                vscode.postMessage({ command: 'stopStream' });

                // Analyze
                visionContainer.style.display = 'block';
                visionDetails.innerText = "Analyzing captured image...";
                visionThumb.innerHTML = `<img src="data:image/jpeg;base64,${base64}" style="width: 100%; height: 100%; object-fit: cover;">`;

                vscode.postMessage({
                    command: 'analyzeImage',
                    base64: base64
                });
            });
        }

        if (btnCloseStream) {
            btnCloseStream.addEventListener('click', () => {
                cameraStreamContainer.style.display = 'none';
                cameraStreamImg.src = '';
                vscode.postMessage({ command: 'stopStream' }); // Stop python backing
            });
        }

        if (btnRecordStart) {
            btnRecordStart.addEventListener('click', () => {
                btnRecordStart.style.display = 'none';
                btnRecordStop.style.display = 'block';
                vscode.postMessage({ command: 'startRecording', url: currentStreamUrl });
            });
        }

        if (btnRecordStop) {
            btnRecordStop.addEventListener('click', () => {
                btnRecordStop.style.display = 'none';
                btnRecordStart.style.display = 'block';
                cameraStreamContainer.style.display = 'none'; // Close view on stop
                vscode.postMessage({ command: 'stopRecording', url: currentStreamUrl });
            });
        }


        // Handle File Upload
        if (btnCamera) {
            btnCamera.addEventListener('click', () => {
                fileInput.click();
            });
        }

        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64 = event.target.result.split(',')[1];

                    // Show loading state
                    visionContainer.style.display = 'block';
                    visionDetails.innerText = "Analyzing image...";
                    visionThumb.innerHTML = `<img src="${event.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;

                    vscode.postMessage({
                        command: 'analyzeImage',
                        base64: base64
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        if (btnUseReference) {
            btnUseReference.addEventListener('click', () => {
                // Visual feedback
                const isActive = btnUseReference.classList.toggle('active');
                if (isActive) {
                    btnUseReference.textContent = "Reference Active";
                    vscode.postMessage({ command: 'useVisionReference', state: true });
                } else {
                    btnUseReference.textContent = "Use as Reference";
                    vscode.postMessage({ command: 'useVisionReference', state: false });
                }
            });
        }

        if (btnDiscardVision) {
            btnDiscardVision.addEventListener('click', () => {
                visionContainer.style.display = 'none';
                visionDetails.innerText = "No image analyzed.";
                visionThumb.innerHTML = '<span style="font-size: 24px;">üì∑</span>';
                fileInput.value = ''; // Reset file input

                // Reset reference button
                if (btnUseReference) {
                    btnUseReference.classList.remove('active');
                    btnUseReference.textContent = "Use as Reference";
                }

                vscode.postMessage({ command: 'discardVision' });
            });
        }

        if (btnBuild) {
            btnBuild.addEventListener('click', () => {
                deploymentStatus.textContent = "Building...";
                vscode.postMessage({ command: 'buildFirmware' });
            });
        }

        if (btnFlash) {
            btnFlash.addEventListener('click', () => {
                deploymentStatus.textContent = "Starting Flash...";
                vscode.postMessage({ command: 'flashFirmware' });
            });
        }

        if (btnOpenSerial) {
            btnOpenSerial.addEventListener('click', () => {
                vscode.postMessage({ command: 'executeCommand', text: 'aria.openSerialMonitor' });
            });
        }

        if (btnAnalyzeSerial) {
            btnAnalyzeSerial.addEventListener('click', () => {
                serialResults.style.display = 'block';
                serialResults.innerHTML = '<em>Analyzing...</em>';
                vscode.postMessage({ command: 'executeCommand', text: 'aria.analyzeSerialLogs' });
            });
        }

        function updateSerialUI(data) {
            serialResults.style.display = 'block';
            let html = '';

            if (data.thoughtProcess) {
                html += `
                    <div class="thought-process-container">
                        <details open>
                        <summary class="thought-process-header">
                             <span class="status-dot"></span> üß† Thinking Process
                        </summary>
                            <div class="thought-process-content" open>
                                ${data.thoughtProcess.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                        </details>
                    </div>
                `;
            }

            if (data.confidence !== undefined && data.confidence < 1.0) {
                html += `<div style="margin-top: 5px; font-size: 0.8em; opacity: 0.8;">Confidence: ${(data.confidence * 100).toFixed(0)}%</div>`;
            }

            if (data.suspectedIssues && data.suspectedIssues.length > 0) {
                html += `<div style="margin-top:5px; color: #ff5555;"><strong>Issues:</strong></div>`;
                html += `<ul>${data.suspectedIssues.map(i => `<li>${i}</li>`).join('')}</ul>`;
            }

            if (data.likelyRootCauses && data.likelyRootCauses.length > 0) {
                html += `<div style="margin-top:5px;"><strong>Root Causes:</strong></div>`;
                html += `<ul>${data.likelyRootCauses.map(i => `<li>${i}</li>`).join('')}</ul>`;
            }

            if (data.suggestedFixes && data.suggestedFixes.length > 0) {
                html += `<div style="margin-top:10px;"><strong>Suggested Fixes:</strong></div>`;
                data.suggestedFixes.forEach(fix => {
                    html += `<div class="fix-card">`;
                    html += `<div class="fix-description">${fix.description}</div>`;
                    if (fix.diff) {
                        html += `<button class="btn-preview-diff" data-diff="${encodeURIComponent(fix.diff)}" style="font-size: 0.7em; padding: 6px 12px;">Preview Fix</button>`;
                    }
                    html += `</div>`;
                });
            }

            serialResults.innerHTML = html;

            // Re-attach diff listeners
            document.querySelectorAll('.btn-preview-diff').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const diff = decodeURIComponent(e.target.dataset.diff);
                    vscode.postMessage({
                        command: 'previewDiff',
                        diff: diff
                    });
                });
            });
        }

        function updateVisionUI(data) {
            visionContainer.style.display = 'block';

            // Reset button state
            if (btnUseReference) {
                btnUseReference.textContent = "Use as Reference";
                btnUseReference.disabled = false;
                btnUseReference.style.opacity = "1";
            }

            let html = `<strong>Boards:</strong> ${data.detectedBoards.join(', ') || 'None'}<br>`;
            html += `<strong>Components:</strong> ${data.detectedComponents.join(', ') || 'None'}<br>`;
            html += `<strong>Confidence:</strong> ${(data.confidence * 100).toFixed(0)}%`;

            visionDetails.innerHTML = html;

            if (data.mismatchWarning) {
                visionWarnings.style.display = 'block';
                visionWarnings.innerText = `‚ö†Ô∏è ${data.mismatchWarning}`;
            } else {
                visionWarnings.style.display = 'none';
            }
        }

        const AVAILABLE_COMMANDS = [
            '/analyze',
            '/selection',
            '/workspace',
            '/validate',
            '/capture',
            '/help'
        ];

        const CONTEXT_MENU_ITEMS = [
            // Contexts
            '@workspace',
            '@file',
            '@selection',
            '@terminal',
            '@changes',
            '@problems',
            // Commands
            '@analyze',
            '@help',
            '@clear',
            // Actions
            '@build', // Build Firmware
            '@flash', // Flash Firmware
            '@serial', // Open Serial Monitor
            '@logs', // Analyze Serial Logs
            '@camera', // Capture Image
            '@video' // Capture Video
        ];

        let currentFocus = -1;

        // Focus input on load
        input.focus();

        // Input Event for Autocomplete
        input.addEventListener('input', function (e) {
            const val = this.value;
            closeAllLists();

            if (!val) return false;

            let matches = [];
            let isCommand = false;
            let isContext = false;

            if (val.startsWith('/')) {
                matches = AVAILABLE_COMMANDS.filter(cmd => cmd.toLowerCase().startsWith(val.toLowerCase()));
                isCommand = true;
            } else if (val.startsWith('@')) {
                // If val is just '@', show all context items
                if (val === '@') {
                    matches = CONTEXT_MENU_ITEMS;
                } else {
                    matches = CONTEXT_MENU_ITEMS.filter(item => item.toLowerCase().startsWith(val.toLowerCase()));
                }
                isContext = true;
            } else {
                return false;
            }

            currentFocus = -1;

            if (matches.length > 0) {
                autocompleteList.style.display = 'block';
                matches.forEach(match => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';

                    // Icon logic
                    let icon = '';
                    if (isContext) {
                        if (match === '@workspace') icon = 'üìÇ ';
                        else if (match === '@file') icon = 'üìÑ ';
                        else if (match === '@selection') icon = 'üìù ';
                        else if (match === '@terminal') icon = 'üíª ';
                        else if (match === '@build') icon = 'üî® ';
                        else if (match === '@flash') icon = '‚ö° ';
                        else if (match === '@serial') icon = 'üîå ';
                        else if (match === '@logs') icon = 'üìú ';
                        else if (match === '@camera') icon = 'üì∑ ';
                        else if (match === '@video') icon = 'üé• ';
                        else if (match === '@analyze') icon = 'üß† ';
                        else if (match === '@help') icon = '‚ùì ';
                        else icon = 'üîó ';
                    } else {
                        icon = '‚ö° ';
                    }

                    // Highlight match
                    item.innerHTML = `${icon}<strong>${match.substr(0, val.length)}</strong>${match.substr(val.length)}`;
                    item.innerHTML += `<input type='hidden' value='${match}'>`;

                    item.addEventListener('click', function (e) {
                        input.value = this.getElementsByTagName('input')[0].value;
                        closeAllLists();
                        input.focus();
                    });

                    autocompleteList.appendChild(item);
                });
            }
        });

        // Handle Keys (Enter, Up, Down)
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent submitting form if we select from list

                if (currentFocus > -1) {
                    if (autocompleteList.style.display !== 'none') {
                        const items = autocompleteList.getElementsByTagName('div');
                        if (items[currentFocus]) {
                            items[currentFocus].click();
                            return; // Don't send command yet, just select
                        }
                    }
                }

                const text = input.value.trim();
                if (text) {
                    closeAllLists();
                    sendCommand(text);
                    input.value = '';
                }
            } else if (e.key === 'ArrowDown') {
                currentFocus++;
                addActive(autocompleteList.getElementsByTagName('div'));
            } else if (e.key === 'ArrowUp') {
                currentFocus--;
                addActive(autocompleteList.getElementsByTagName('div'));
            } else if (e.key === 'Escape') {
                closeAllLists();
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("active");
            // Scroll to view
            x[currentFocus].scrollIntoView({ block: 'nearest' });
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("active");
            }
        }

        function closeAllLists(elmnt) {
            autocompleteList.innerHTML = '';
            autocompleteList.style.display = 'none';
        }

        // Close list when clicking elsewhere
        document.addEventListener("click", function (e) {
            if (e.target !== input && e.target !== autocompleteList) {
                closeAllLists();
            }
        });

        // Send to Extension
        function sendCommand(text) {
            // Optimistically show command
            addEntry(text, 'command');

            // Send to backend
            vscode.postMessage({
                command: 'executeCommand',
                text: text
            });
        }
    </script>
</body>

</html>