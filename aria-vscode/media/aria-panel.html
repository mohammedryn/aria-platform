<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; connect-src http://127.0.0.1:*; frame-src http://127.0.0.1:*; img-src vscode-resource: https: data: blob: http://127.0.0.1:*; script-src 'unsafe-inline'; style-src 'unsafe-inline'; media-src vscode-resource: https: data: blob: mediastream: http://127.0.0.1:*;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.R.I.A. Copilot</title>
    <style>
        :root {
            --input-radius: 12px;
            --card-radius: 8px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --user-bubble-bg: var(--vscode-button-secondaryBackground);
            --user-bubble-fg: var(--vscode-button-secondaryForeground);
            --ai-bubble-bg: transparent;
            --ai-bubble-fg: var(--vscode-foreground);
        }

        body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--vscode-scrollbarSlider-background); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--vscode-scrollbarSlider-hoverBackground); }
        ::-webkit-scrollbar-track { background: transparent; }

        /* --- Layout --- */
        #main-wrapper {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #result-stream {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px 20px 180px 20px; /* Bottom padding for fixed input */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #bottom-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px 20px 20px;
            background: linear-gradient(to top, var(--vscode-editor-background) 90%, transparent);
            z-index: 100;
        }

        /* --- Chat Entries --- */
        .entry {
            display: flex;
            flex-direction: column;
            gap: 8px;
            animation: fadeIn 0.2s ease-out;
            max-width: 100%;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .entry-command {
            align-self: flex-end;
            background-color: var(--user-bubble-bg);
            color: var(--user-bubble-fg);
            padding: 10px 14px;
            border-radius: 12px;
            border-bottom-right-radius: 2px;
            font-size: 0.9em;
            max-width: 85%;
            border: 1px solid var(--vscode-panel-border);
            line-height: 1.4;
        }

        .entry-result {
            align-self: flex-start;
            width: 100%;
            font-size: 0.95em;
            line-height: 1.6;
            background-color: var(--ai-bubble-bg);
            color: var(--ai-bubble-fg);
        }

        /* --- Markdown Styling --- */
        .entry-result p { margin-bottom: 10px; }
        .entry-result ul, .entry-result ol { margin-left: 20px; margin-bottom: 10px; }
        .entry-result li { margin-bottom: 4px; }
        
        /* --- Code Blocks & Diffs --- */
        pre { 
            background: var(--vscode-textCodeBlock-background); 
            padding: 10px; 
            border-radius: 6px; 
            overflow-x: auto; 
            margin: 10px 0; 
            position: relative;
            border: 1px solid var(--vscode-widget-border);
        }
        code { 
            font-family: var(--vscode-editor-font-family); 
            font-size: 0.9em; 
        }
        p > code {
            background: var(--vscode-textCodeBlock-background);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* --- Cards & Context Panels --- */
        .analysis-card, .context-panel {
            background-color: var(--vscode-sideBar-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: var(--card-radius);
            padding: 15px;
            margin-bottom: 10px;
        }

        .context-panel {
            display: none;
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Input Area (Cursor Style) --- */
        .input-box {
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: var(--input-radius);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            transition: border-color 0.2s;
        }

        .input-box:focus-within {
            border-color: var(--vscode-focusBorder);
        }

        textarea#command-input {
            background: transparent;
            border: none;
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-editor-font-family);
            font-size: 0.95em;
            width: 100%;
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 200px;
            overflow-y: hidden;
            line-height: 1.5;
        }

        .input-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 4px;
        }

        .tools-left, .tools-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pill-badge {
            font-size: 0.75em;
            background: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            padding: 2px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            user-select: none;
        }

        .model-select {
            position: relative;
        }
        .model-select-pill {
            background: #0b0b0b;
            color: #e6e6e6;
            border: 1px solid #1f1f1f;
            font-size: 0.8em;
            cursor: pointer;
            outline: none;
            padding: 4px 10px;
            border-radius: 6px;
            min-width: 180px;
            max-width: 240px;
            text-align: left;
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .model-select-pill:hover { background: #111; color: #fff; }
        .model-select-pill:focus { border-color: #2a2a2a; }
        .model-select-pill span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .model-menu {
            position: absolute;
            bottom: calc(100% + 6px);
            left: 0;
            width: 280px;
            max-height: 320px;
            overflow-y: auto;
            background: #0b0b0b;
            color: #e6e6e6;
            border: 1px solid #1f1f1f;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.35);
            display: none;
            z-index: 1100;
        }
        .model-menu.open { display: block; }
        .model-item {
            width: 100%;
            background: transparent;
            color: inherit;
            border: none;
            text-align: left;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .model-item:hover { background: #141414; }
        .model-item.active { background: #1a1a1a; }
        .model-item[disabled] { color: #777; cursor: not-allowed; }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background: var(--vscode-toolbar-hoverBackground); }

        .submit-btn {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .submit-btn:hover { background: var(--vscode-button-hoverBackground); }

        /* --- Autocomplete --- */
        #autocomplete-list {
            position: absolute;
            bottom: 100%;
            left: 0; right: 0;
            background-color: var(--vscode-menu-background);
            color: var(--vscode-menu-foreground);
            border: 1px solid var(--vscode-menu-border);
            border-radius: 6px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            margin-bottom: 5px;
        }
        .autocomplete-item { padding: 8px 12px; cursor: pointer; font-size: 0.9em; }
        .autocomplete-item:hover, .autocomplete-item.active { background-color: var(--vscode-menu-selectionBackground); color: var(--vscode-menu-selectionForeground); }

        /* --- Thinking Process (Collapsible) --- */
        details.thinking-process {
            margin: 10px 0;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 6px;
            background-color: var(--vscode-editor-inactiveSelectionBackground);
            overflow: hidden;
        }
        
        details.thinking-process summary {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            user-select: none;
            outline: none;
            display: flex;
            align-items: center;
            color: var(--vscode-descriptionForeground);
        }
        
        details.thinking-process summary:hover {
            color: var(--vscode-foreground);
        }

        .thinking-content {
            padding: 10px 12px;
            font-family: var(--vscode-editor-font-family);
            font-size: 0.9em;
            white-space: pre-wrap;
            border-top: 1px solid var(--vscode-panel-border);
            color: var(--vscode-descriptionForeground);
        }

        /* --- Action Buttons (Apply/Copy) --- */
        .code-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        pre:hover .code-actions { opacity: 1; }

        .action-btn {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
        }
        .action-btn:hover { background: var(--vscode-button-secondaryHoverBackground); }

        /* --- "Apply All" Button --- */
        .bulk-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--vscode-panel-border);
            display: flex;
            justify-content: flex-end;
        }
        
        .apply-all-btn {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .apply-all-btn:hover { background: var(--vscode-button-hoverBackground); }

        /* --- History Drawer --- */
        #history-drawer {
            position: fixed; top: 0; left: 0; bottom: 0; width: 250px;
            background-color: var(--vscode-sideBar-background);
            border-right: 1px solid var(--vscode-panel-border);
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        #history-drawer.open { transform: translateX(0); }
        #history-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1999; display: none;
        }
        #history-overlay.open { display: block; }
        .history-header { padding: 15px; border-bottom: 1px solid var(--vscode-panel-border); display: flex; justify-content: space-between; align-items: center; }
        .history-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .history-item { padding: 10px; cursor: pointer; border-radius: 4px; margin-bottom: 5px; position: relative; }
        .history-item:hover { background-color: var(--vscode-list-hoverBackground); }
    </style>
</head>
<body>
    <!-- History Components -->
    <div id="history-overlay"></div>
    <div id="history-drawer">
        <div class="history-header">
            <span>Chat History</span>
            <button id="btn-close-history" class="icon-btn">âœ•</button>
        </div>
        <div style="padding: 10px;">
            <button id="btn-new-chat" style="width: 100%; background: var(--vscode-button-background); color: var(--vscode-button-foreground); border: none; padding: 8px; cursor: pointer; border-radius: 4px;">+ New Chat</button>
        </div>
        <div id="history-list" class="history-list"></div>
    </div>

    <!-- Header (Hidden History Toggle) -->
    <div style="position: absolute; top: 10px; right: 20px; z-index: 50;">
        <button id="btn-toggle-history" class="icon-btn" style="font-size: 1.2em;">â˜°</button>
    </div>

    <!-- Main Content -->
    <div id="main-wrapper">
        <div id="result-stream">
            <!-- Intro Message -->
            <div class="entry">
                <div class="entry-result">
                    <div style="opacity: 0.7; font-size: 0.9em; text-align: center; margin-top: 40px;">
                        <div style="font-weight: 600; font-size: 1.2em; margin-bottom: 5px;">A.R.I.A. Hardware Agent</div>
                        <div>Gemini 3.0 â€¢ Hardware-Aware â€¢ Passive Vision</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Interface -->
    <div id="bottom-container">
        <!-- Active Context Zone (Floating Panels) -->
        <div id="context-zone">
            <!-- Vision Context -->
            <div id="vision-container" class="context-panel">
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <div id="vision-thumb" style="width: 60px; height: 60px; background: #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; overflow: hidden;">ðŸ“·</div>
                    <div style="flex-grow: 1;">
                        <h3 style="margin: 0 0 5px 0;">Visual Context</h3>
                        <div id="vision-details" style="font-size: 0.85em; opacity: 0.9;">Analyzing...</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button id="btn-use-reference" class="icon-btn" title="Use as Reference">ðŸ“Œ</button>
                        <button id="btn-discard-vision" class="icon-btn" title="Discard">âœ•</button>
                    </div>
                </div>
            </div>

            <!-- Firmware Tools -->
            <div id="firmware-container" class="context-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="margin:0;">Firmware Deployment</h3>
                    <span id="deployment-status" style="font-size: 0.8em; opacity: 0.7;">Ready</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="btn-build" style="flex: 1; padding: 6px; background: var(--vscode-button-background); color: white; border: none; border-radius: 4px; cursor: pointer;">Build</button>
                    <button id="btn-flash" style="flex: 1; padding: 6px; background: var(--vscode-button-secondaryBackground); color: white; border: none; border-radius: 4px; cursor: pointer;">Flash</button>
                </div>
            </div>
        </div>

        <!-- Input Box -->
        <div id="command-bar">
            <div id="autocomplete-list"></div>
            <div class="input-box">
                <textarea id="command-input" rows="1" placeholder="Ask A.R.I.A... (@ for context, / for commands)"></textarea>
                <div class="input-toolbar">
                    <div class="tools-left">
                        <div class="pill-badge">
                            <span class="status-dot" style="height: 6px; width: 6px; border-radius: 50%; background-color: var(--vscode-charts-blue); display: inline-block;"></span> Agent
                        </div>
                        <div class="model-select">
                            <button id="model-button" class="model-select-pill" type="button">
                                <span>Loading models...</span>
                                <span>â–¾</span>
                            </button>
                            <div id="model-menu" class="model-menu"></div>
                        </div>
                    </div>
                    <div class="tools-right">
                        <button id="model-refresh" class="icon-btn" title="Refresh Models">â†»</button>
                        <button id="btn-camera" class="icon-btn" title="Add Image">ðŸ“·</button>
                        <button id="btn-video" class="icon-btn" title="Add Video">ðŸŽ¥</button>
                        <button id="btn-submit" class="submit-btn">âž¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="file-input" accept="image/png, image/jpeg" style="display: none;" />

    <script>
        const vscode = acquireVsCodeApi();
        const input = document.getElementById('command-input');
        const stream = document.getElementById('result-stream');
        const autocompleteList = document.getElementById('autocomplete-list');
        const fileInput = document.getElementById('file-input');
        const btnCamera = document.getElementById('btn-camera');
        const btnSubmit = document.getElementById('btn-submit');
        const modelButton = document.getElementById('model-button');
        const modelMenu = document.getElementById('model-menu');
        const modelRefresh = document.getElementById('model-refresh');
        let currentModel = '';
        
        let commandHistory = [];
        let historyIndex = -1;

        // --- Auto-Resize Textarea ---
        function autoResize() {
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 200) + 'px';
        }
        input.addEventListener('input', autoResize);

        // --- Message Handling ---
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'addEntry':
                    addEntry(message.text, message.isUser, message.metadata);
                    break;
                case 'analysisResult':
                    renderAnalysis(message.analysis);
                    break;
                case 'updateHistory':
                    updateHistoryDrawer(message.history);
                    break;
                case 'showVision':
                    document.getElementById('vision-container').style.display = 'block';
                    break;
                case 'hideVision':
                    document.getElementById('vision-container').style.display = 'none';
                    break;
                case 'successMessage':
                    addEntry(message.text, false); // Add as system message
                    break;
                case 'analysisError':
                    addEntry(`âš ï¸ **Error:** ${message.error}`, false);
                    break;
                case 'modelList':
                    updateModelList(message.models || [], message.selected, message.error);
                    break;
                case 'modelSelected':
                    if (message.model) {
                        currentModel = message.model;
                        updateModelButton(message.model);
                        closeModelMenu();
                    }
                    break;
            }
        });

        // --- Rendering Logic ---
        function addEntry(text, isUser, metadata) {
            const container = document.createElement('div');
            container.className = 'entry';
            
            const content = document.createElement('div');
            content.className = isUser ? 'entry-command' : 'entry-result';
            
            if (isUser) {
                content.textContent = text;
            } else {
                content.innerHTML = parseMarkdown(text);
            }
            
            container.appendChild(content);
            stream.appendChild(container);
            
            // Auto-scroll
            window.scrollTo(0, document.body.scrollHeight);
            stream.scrollTop = stream.scrollHeight;
        }

        function renderAnalysis(analysis) {
            const container = document.createElement('div');
            container.className = 'entry';
            
            const card = document.createElement('div');
            card.className = 'entry-result analysis-card';
            
            // Render basic markdown content
            if (analysis.content) {
                card.innerHTML = parseMarkdown(analysis.content);
            }

            // Suggestions & Apply All Button
            if (analysis.suggestions && analysis.suggestions.length > 0) {
                const bulkActions = document.createElement('div');
                bulkActions.className = 'bulk-actions';
                
                const applyAllBtn = document.createElement('button');
                applyAllBtn.className = 'apply-all-btn';
                applyAllBtn.innerHTML = '<span>âš¡</span> Apply All Fixes';
                applyAllBtn.onclick = () => {
                    const diffs = analysis.suggestions.map(s => s.diff);
                    vscode.postMessage({ command: 'applyAllDiffs', diffs: diffs });
                    applyAllBtn.textContent = 'Applying...';
                    applyAllBtn.disabled = true;
                };
                
                bulkActions.appendChild(applyAllBtn);
                card.appendChild(bulkActions);
            }
            
            container.appendChild(card);
            stream.appendChild(container);
            stream.scrollTop = stream.scrollHeight;
        }

        // --- Markdown Parser with Collapsible Thinking ---
        function parseMarkdown(text) {
            if (!text) return '';
            
            let html = text;

            // 1. Thinking Process (Collapse it)
            // Regex to find content between # Thinking Process and # Final Summary (or end)
            // We replace the header and wrap the content in <details>
            const thinkingRegex = /#\s*Thinking Process\s*\n([\s\S]*?)(?=\n#\s*Final Summary|$)/i;
            html = html.replace(thinkingRegex, (match, content) => {
                return `<details class="thinking-process">
                    <summary>Thinking Process</summary>
                    <div class="thinking-content">${markedParse(content)}</div>
                </details>`;
            });

            // 2. Final Summary Header (Remove or Style)
            html = html.replace(/#\s*Final Summary\s*/i, '');

            // 3. Parse remaining Markdown
            html = markedParse(html);

            return html;
        }

        // Simple Markdown Parser (Replace with marked.js if available, but this is a lightweight fallback)
        function markedParse(text) {
            let html = text
                // Code Blocks with Actions
                .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    const id = 'code-' + Math.random().toString(36).substr(2, 9);
                    return `<div style="position:relative;">
                        <div class="code-actions">
                            <button class="action-btn" onclick="copyCode('${id}')">Copy</button>
                            <button class="action-btn" onclick="applyCode('${id}')">Apply</button>
                        </div>
                        <pre><code id="${id}" class="language-${lang || ''}">${escapeHtml(code)}</code></pre>
                    </div>`;
                })
                // Inline Code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Bold
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                // Lists
                .replace(/^\s*-\s+(.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                // Line breaks
                .replace(/\n/g, '<br>');
            
            return html;
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Utility Functions ---
        window.copyCode = (id) => {
            const code = document.getElementById(id).innerText;
            navigator.clipboard.writeText(code);
        };

        window.applyCode = (id) => {
            const code = document.getElementById(id).innerText;
            // Detect if it's a diff or file
            if (code.startsWith('---') || code.startsWith('+++')) {
                vscode.postMessage({ command: 'applyDiff', diff: code });
            } else {
                vscode.postMessage({ command: 'applyFile', content: code });
            }
        };

        // --- Event Listeners ---
        function requestModels() {
            vscode.postMessage({ command: 'getModels' });
        }

        function updateModelButton(text) {
            if (!modelButton) return;
            const label = modelButton.querySelector('span');
            if (label) label.textContent = text;
        }

        function closeModelMenu() {
            if (modelMenu) modelMenu.classList.remove('open');
        }

        function updateModelList(models, selected, error) {
            if (!modelMenu) return;
            modelMenu.innerHTML = '';
            currentModel = selected || currentModel || (models[0] || '');
            updateModelButton(currentModel || 'Select model');

            if (!models || models.length === 0) {
                const item = document.createElement('button');
                item.className = 'model-item';
                item.textContent = error ? 'No models (set API key)' : 'No models available';
                item.disabled = true;
                modelMenu.appendChild(item);
                return;
            }

            models.forEach(model => {
                const item = document.createElement('button');
                item.className = 'model-item';
                item.textContent = model;
                if (model === currentModel) item.classList.add('active');
                item.addEventListener('click', () => {
                    currentModel = model;
                    updateModelButton(model);
                    vscode.postMessage({ command: 'setModel', model });
                    closeModelMenu();
                });
                modelMenu.appendChild(item);
            });
        }

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const text = input.value.trim();
                if (text) {
                    vscode.postMessage({ command: 'execute', text });
                    input.value = '';
                    autoResize();
                }
            }
        });

        btnSubmit.addEventListener('click', () => {
            const text = input.value.trim();
            if (text) {
                vscode.postMessage({ command: 'execute', text });
                input.value = '';
                autoResize();
            }
        });

        if (modelRefresh) {
            modelRefresh.addEventListener('click', () => {
                requestModels();
            });
        }

        if (modelButton) {
            modelButton.addEventListener('click', () => {
                if (modelMenu) {
                    modelMenu.classList.toggle('open');
                }
            });
        }

        document.addEventListener('click', (e) => {
            const target = e.target;
            if (!modelMenu || !modelButton) return;
            if (modelMenu.contains(target) || modelButton.contains(target)) return;
            closeModelMenu();
        });

        // History Toggle
        document.getElementById('btn-toggle-history').addEventListener('click', () => {
            document.getElementById('history-drawer').classList.add('open');
            document.getElementById('history-overlay').classList.add('open');
        });
        
        document.getElementById('btn-close-history').addEventListener('click', () => {
            document.getElementById('history-drawer').classList.remove('open');
            document.getElementById('history-overlay').classList.remove('open');
        });
        
        document.getElementById('history-overlay').addEventListener('click', () => {
            document.getElementById('history-drawer').classList.remove('open');
            document.getElementById('history-overlay').classList.remove('open');
        });

        // Initialize
        autoResize();
        requestModels();
    </script>
</body>
</html>
